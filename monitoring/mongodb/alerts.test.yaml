# These tests are meant to go hand-in-hand with the rendered alert rule.
# Use github.com/scality/action-prom-render-test@python-renderer python module
#
# Render the alerts file with
#   alertgen alerts.yaml -i 'namespace=zenko,service=data-db-mongodb-sharded,pvc=datadir-mongodb,replicas=3'

evaluation_interval: 30s

rule_files:
  - alerts.rendered.yaml

tests:
  - name: MongoDbDown
    interval: 30s
    input_series:
      - series: up{namespace="zenko", job="zenko/data-db-mongodb-sharded-mongos", pod="data-db-mongodb-sharded-mongos-0"}
        values: 1 1 0 0 0 0 1 1 1
      - series: up{namespace="zenko", job="zenko/data-db-mongodb-sharded-mongos", pod="data-db-mongodb-sharded-mongos-1"}
        values: 1 1 1 1 0 0 0 1 1
      - series: up{namespace="zenko", job="zenko/data-db-mongodb-sharded-mongos", pod="data-db-mongodb-sharded-mongos-2"}
        values: 1 1 1 1 1 0 0 0 1
    alert_rule_test:
      - { alertname: MongoDbDegraded, eval_time: 30s, exp_alerts: [] }
      - { alertname: MongoDbCritical, eval_time: 30s, exp_alerts: [] }

      - { alertname: MongoDbDegraded, eval_time: 60s, exp_alerts: [] }
      - { alertname: MongoDbCritical, eval_time: 60s, exp_alerts: [] }

      - { alertname: MongoDbCritical, eval_time: 90s, exp_alerts: [] }
      - alertname: MongoDbDegraded
        eval_time: 90s
        exp_alerts:
          - exp_labels:
              severity: warning
              job: mongos
            exp_annotations:
              description: "Less than 100% of MongoDb mongos instances are up and healthy: 2/3."
              summary: MongoDb mongos service degraded

      - { alertname: MongoDbCritical, eval_time: 120s, exp_alerts: [] }
      - alertname: MongoDbDegraded
        eval_time: 120s
        exp_alerts:
          - exp_labels:
              severity: warning
              job: mongos
            exp_annotations:
              description: "Less than 100% of MongoDb mongos instances are up and healthy: 1/3."
              summary: MongoDb mongos service degraded

      - alertname: MongoDbDegraded
        eval_time: 150s
        exp_alerts:
          - exp_labels:
              severity: warning
              job: mongos
            exp_annotations:
              description: "Less than 100% of MongoDb mongos instances are up and healthy: 0/3."
              summary: MongoDb mongos service degraded
      - alertname: MongoDbCritical
        eval_time: 150s
        exp_alerts:
          - exp_labels:
              severity: critical
              job: mongos
            exp_annotations:
              description: "Less than 50% of MongoDb mongos instances are up and healthy: 0/3."
              summary: MongoDb mongos service critical
      
      - alertname: MongoDbDegraded
        eval_time: 180s
        exp_alerts:
          - exp_labels:
              severity: warning
              job: mongos
            exp_annotations:
              description: "Less than 100% of MongoDb mongos instances are up and healthy: 1/3."
              summary: MongoDb mongos service degraded
      - alertname: MongoDbCritical
        eval_time: 180s
        exp_alerts:
          - exp_labels:
              severity: critical
              job: mongos
            exp_annotations:
              description: "Less than 50% of MongoDb mongos instances are up and healthy: 1/3."
              summary: MongoDb mongos service critical

  - interval: 1m
    input_series:
      - series: mongodb_rs_members_state{namespace="zenko",pod="mongodb-0",member_state="PRIMARY"}
        values: 1 _

    alert_rule_test:
      - alertname: NoPrimary
        eval_time: 1m
        exp_alerts: []
      - alertname: NoPrimary
        eval_time: 2m
        exp_alerts:
          - exp_labels:
              namespace: zenko
              state: PRIMARY
              severity: critical
            exp_annotations:
              description: "MongoDb down"
              summary: MongoDb down

  - interval: 30s
    input_series:
      - series: mongodb_rs_members_health{namespace="zenko",pod="mongodb-0", member_idx="mongodb-0", member_state="PRIMARY"}
        values: 1 1 1 1
      - series: mongodb_rs_members_health{namespace="zenko",pod="mongodb-0", member_idx="mongodb-1", member_state="SECONDARY"}
        values: 1 1 1 1
      - series: mongodb_rs_members_health{namespace="zenko",pod="mongodb-0", member_idx="mongodb-2", member_state="SECONDARY"}
        values: 1 1 0 0
      - series: mongodb_rs_members_health{namespace="zenko",pod="mongodb-1", member_idx="mongodb-0", member_state="PRIMARY"}
        values: 1 1 1 1
      - series: mongodb_rs_members_health{namespace="zenko",pod="mongodb-1", member_idx="mongodb-1", member_state="SECONDARY"}
        values: 1 1 1 1
      - series: mongodb_rs_members_health{namespace="zenko",pod="mongodb-1", member_idx="mongodb-2", member_state="SECONDARY"}
        values: 1 1 0 0
      - series: mongodb_rs_members_health{namespace="zenko",pod="mongodb-2", member_idx="mongodb-0", member_state="PRIMARY"}
        values: 1 1 _ _
      - series: mongodb_rs_members_health{namespace="zenko",pod="mongodb-2", member_idx="mongodb-1", member_state="SECONDARY"}
        values: 1 1 _ _
      - series: mongodb_rs_members_health{namespace="zenko",pod="mongodb-2", member_idx="mongodb-2", member_state="SECONDARY"}
        values: 1 1 _ _

    alert_rule_test:
      - alertname: UnhealthyMemberWarning
        eval_time: 1m
        exp_alerts: []
      - alertname: UnhealthyMemberWarning
        eval_time: 2m
        exp_alerts:
          - exp_labels:
              name: mongodb-2
              severity: warning
              state: SECONDARY
            exp_annotations:
              description: Member mongodb-2 (SECONDARY) is not healthy
              summary: Unhealthy MongoDb member

  - interval: 30s
    input_series:
      - series: mongodb_rs_members_electionDate{namespace="zenko", pod="mongodb", set="rs0"}
        values: 1+0x9 10+1x10

    alert_rule_test:
      - alertname: TooManyElectionsWarning
        eval_time: 9m
        exp_alerts: []
      - alertname: TooManyElectionsWarning
        eval_time: 10m
        exp_alerts:
          - exp_labels:
              severity: warning
              set: rs0
            exp_annotations:
              description: Number of elections is greater than 10 in 10m
              summary: Too many elections

  - interval: 1m
    input_series:
      - series: mongodb_rs_members_optimeDate{namespace="zenko",pod="mongodb-0", member_idx="mongo-0", member_state="PRIMARY"}
        values: 5 25 35
      - series: mongodb_rs_members_optimeDate{namespace="zenko",pod="mongodb-1", member_idx="mongo-1", member_state="SECONDARY"}
        values: 0 12 29
      - series: mongodb_rs_members_optimeDate{namespace="zenko",pod="mongodb-2", member_idx="mongo-2", member_state="SECONDARY"}
        values: 2 2 31

    alert_rule_test:
      - alertname: ReplicationLagWarning
        eval_time: 1m
        exp_alerts: []
      - alertname: ReplicationLagWarning
        eval_time: 2m
        exp_alerts:
          - exp_labels:
              severity: warning
            exp_annotations:
              description: Mongodb replication lag is more than 10s
              summary: MongoDB replication lag
      - alertname: ReplicationLagWarning
        eval_time: 3m
        exp_alerts: []

  - interval: 1m
    input_series:
      - series: mongodb_ss_connections{namespace="zenko",pod="mongodb-0",conn_type="current"}
        values: 90 98 110 110

    alert_rule_test:
      - alertname: TooManyClientConnectionsWarning
        eval_time: 2m
        exp_alerts: []
      - alertname: TooManyClientConnectionsWarning
        eval_time: 4m
        exp_alerts:
          - exp_labels:
              severity: warning
            exp_annotations:
              description: Too many client connections
              summary: Too many MongoDB client connections

  - interval: 1m
    input_series:
      - series: kubelet_volume_stats_available_bytes{namespace="zenko",persistentvolumeclaim="datadir-mongodb-0"}
        values: 30-5x3
      - series: kubelet_volume_stats_capacity_bytes{namespace="zenko",persistentvolumeclaim="datadir-mongodb-0"}
        values: 100+0x3

    alert_rule_test:
      - alertname: RemainingDiskSpaceWarning
        eval_time: 2m
        exp_alerts: []
      - alertname: RemainingDiskSpaceWarning
        eval_time: 4m
        exp_alerts:
          - exp_labels:
              severity: warning
              namespace: zenko
              persistentvolumeclaim: datadir-mongodb-0
            exp_annotations:
              description: MongoDb has low disk space
              summary: MongoDb has low disk space


