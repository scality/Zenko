# Variables which should be replaced. Similar to grafana dashboards' __inputs section
x-inputs:
  - name: namespace
    type: constant
    value: zenko
  - name: service
    type: constant
    value: mongodb
  - name: pvc
    type: constant
    value: datadir-mongodb
  - name: tooManyElectionsWarningThreshold
    type: constant
    value: 10
  - name: tooManyClientConnectionsWarningThreshold
    type: constant
    value: 100
  - name: remainingDiskSpaceWarningThreshold
    type: constant
    value: 0.25

groups:
- name: MongoDb
  rules:

  - alert: MongoDbDown
    expr: |
      sum(up{namespace="${namespace}",job="${service}"}) == 0
    for: 0m
    labels:
      severity: critical
    annotations:
      description: "MongoDb down"
      summary: MongoDb Down

  - alert: NoPrimary
    expr: |
      count by(set) (mongodb_mongod_replset_member_state{namespace="${namespace}",job="${service}",state="PRIMARY"}) == 0
    for: 0m
    labels:
      severity: critical
    annotations:
      description: "MongoDb down"
      summary: MongoDb Down

  - alert: UnhealthyMemberWarning
    expr: |
      group by(name, state) (mongodb_mongod_replset_member_health{namespace="${namespace}",job="${service}"}) != 1
    for: 30s
    labels:
      severity: warning
    annotations:
      description: "Member {{ $labels.name }} ({{ $labels.state }}) is not healthy"
      summary: Unhealthy MongoDb member

  - alert: TooManyElectionsWarning
    expr: |
      group by(set) (changes(mongodb_mongod_replset_member_election_date{namespace="${namespace}",job="${service}"}[10m]))
        > ${tooManyElectionsWarningThreshold}
    for: 0s
    labels:
      severity: warning
    annotations:
      description: "Number of elections is greater than ${tooManyElectionsWarningThreshold} in 10m"
      summary: Too many elections

  - alert: ReplicationLagWarning
    expr: |
      group by(name) mongodb_mongod_replset_member_replication_lag{namespace="${namespace}",job="${service}"}
        > 10
    for: 30s
    labels:
      severity: warning
    annotations:
      description: "Mongodb replication lag is more than 10s on {{ $labels.name }}"
      summary: MongoDB replication lag

  - alert: TooManyClientConnectionsWarning
    expr: |
      sum(mongodb_connections{namespace="${namespace}",job="${service}",state="current"})
        > ${tooManyClientConnectionsWarningThreshold}
    for: 2m
    labels:
      severity: warning
    annotations:
      description: "Too many client connections"
      summary: Too many MongoDB client connections

  - alert: RemainingDiskSpaceWarning
    expr: |
      kubelet_volume_stats_available_bytes{namespace="${namespace}",persistentvolumeclaim=~"${pvc}-.*"}
          / kubelet_volume_stats_capacity_bytes{namespace="${namespace}",persistentvolumeclaim=~"${pvc}-.*"}
        < ${remainingDiskSpaceWarningThreshold}
      and
        predict_linear(kubelet_volume_stats_available_bytes{namespace="${namespace}",persistentvolumeclaim=~"${pvc}-.*"}[6h], 4 * 24 * 3600) < 0
    for: 2m
    labels:
      severity: warning
    annotations:
      description: 'MongoDb has low disk space'
      summary: 'MongoDb has low disk space'
